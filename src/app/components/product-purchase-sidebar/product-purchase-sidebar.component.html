<section class="purchase-sidebar">
  <!-- Price -->
  <div class="price-block">
    @if (hasAllOptionsSelected()) {
      <div class="price-row">
        <span class="price">{{ calculatedPrice() | currency: 'EUR' : 'symbol' : '1.2-2' }}</span>
        <span class="tax-note">Tax included</span>
      </div>
    } @else {
      <span class="price-hint">From</span>
      <div class="price-row">
        <span class="price">{{ product().cheapestPrice | currency: 'EUR' : 'symbol' : '1.2-2' }}</span>
        <span class="tax-note">Tax included</span>
      </div>
    }
    <p class="text-xs text-slate-400 mt-1">Made in <span style="color: #167a92">Den Bosch</span> by a small family studio</p>
  </div>

  <!-- Size first -->
  <div class="option-group">
    <div class="flex items-center justify-between gap-2">
      <label class="option-label">Size</label>
      @if (product().metadata) {
        <app-dpi-bar [metadata]="product().metadata" [size]="selectedSize()"></app-dpi-bar>
      }
    </div>
    <app-size-options [sizes]="availableSizes()" [(sizeSelected)]="selectedSize"></app-size-options>
  </div>
  <!-- Other Options -->
  @for (group of this.product().optionGroups; track group.name; let groupIndex = $index) {
    @if (group.name.toLowerCase() == 'frame') {
      <div class="option-group">
        <label class="option-label">{{ group.name }}</label>
        <app-frame-options [group]="group" (optionSelected)="selectFrame(groupIndex, $event)"></app-frame-options>
      </div>
    } @else if (group.name.toLowerCase() == 'including mat' && isFrameSelected()) {
      <div class="option-group">
        <label class="option-label">{{ group.name }}</label>
        <app-mat-options [(isMatIncluded)]="isMatIncluded"></app-mat-options>
      </div>
    } @else if (group.name.toLowerCase().startsWith('paper')) {
      <div class="option-group">
        <label class="option-label">{{ group.name }}</label>
        <app-paper-options
          [group]="group"
          (optionSelected)="selectOption(groupIndex, $event)"
          (paperNameSelected)="selectedPaperName.set($event)"
        ></app-paper-options>
      </div>
    } @else if (group.name.toLowerCase().startsWith('customproductdetails')) {
      <!-- Nothing to show -->
    } @else if (group.name.toLowerCase() === 'size') {
      <!-- Nothing to show -->
    }
  }

  <!-- Trust points -->
  <ul class="trust-list">
    <li class="trust-item">
      <span class="trust-check">✓</span>
      <span>Fair value, premium quality</span>
    </li>
    <li class="trust-item">
      <span class="trust-check">✓</span>
      <span>30-day returns</span>
    </li>
    <li class="trust-item">
      <span class="trust-check">✓</span>
      <span>Professional finish included</span>
    </li>
  </ul>

  <!-- Action buttons (side by side) -->
  <div class="action-buttons">
    <button
      type="button"
      class="preview-btn"
      [class.disabled]="!selectedSize()"
      [disabled]="!selectedSize()"
      (click)="showPreview.set(true)"
    >
      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
        <circle cx="12" cy="12" r="3"></circle>
      </svg>
      <span>Preview</span>
    </button>
    <button
      type="button"
      [class.disabled]="!hasAllOptionsSelected() || calculatedPrice() <= 0"
      [disabled]="!hasAllOptionsSelected() || calculatedPrice() <= 0"
      (click)="addToCart()"
      class="add-to-cart-btn"
    >
      <app-icon iconName="cart"></app-icon>
      <span>Add to cart</span>
    </button>
  </div>

  <!-- Payment Methods -->
  <div class="flex items-center justify-center gap-1 py-2">
    <span class="text-sm text-slate-400 mr-2">Secure payment with</span>
    <app-icon iconName="stripe" class="w-10 h-7" title="Stripe"></app-icon>
    <app-icon iconName="klarna" class="w-10 h-7" title="Klarna"></app-icon>
    <app-icon iconName="ideal" class="w-10 h-7" title="ideal"></app-icon>
    <app-icon iconName="mastercard" class="w-10 h-7" title="Mastercard"></app-icon>
    <app-icon iconName="visa" class="w-10 h-7" title="Visa"></app-icon>
  </div>

  <!-- Quality badges -->
  <div class="badges">
    <div class="badge">
      <div class="badge-icon">
        <img src="https://genstorageaccount3116.blob.core.windows.net/print-me-custom-product-images/palette_1.svg" alt="" loading="lazy" />
      </div>
      <span class="badge-text">Museum-quality Giclée prints</span>
    </div>
    <div class="badge">
      <div class="badge-icon">
        <app-icon iconName="document" class="w-6 h-6"></app-icon>
      </div>
      <span class="badge-text">Premium 310 g/m² 100% cotton paper</span>
    </div>
  </div>
</section>

<!-- Product Preview Modal -->
@if (selectedSize(); as size) {
  @if (product().images.length) {
    <app-product-preview
      [isOpen]="showPreview()"
      [imageUrl]="product().images[0].large"
      [sizes]="availableSizes()"
      [selectedSize]="size"
      (selectedSizeChange)="selectedSize.set($event)"
      [frameName]="selectedFrameName()"
      [(isMatIncluded)]="isMatIncluded"
      [paperName]="selectedPaperName()"
      (onClose)="showPreview.set(false)"
    ></app-product-preview>
  }
}
